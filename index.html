<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenamiento Pro - Circuito y Cardio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .timer-circle { transition: stroke-dashoffset 0.1s linear; }
        .card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-2xl card rounded-3xl p-6 md:p-8 shadow-2xl">
        <!-- Welcome Screen -->
        <div id="screen-welcome" class="text-center">
            <div class="mb-8">
                <div class="inline-block p-4 bg-blue-900/30 rounded-full mb-6">
                    <span class="text-5xl">üëã</span>
                </div>
                <h1 class="text-4xl font-bold mb-2 text-blue-400">Welcome!</h1>
                <h2 class="text-3xl font-bold text-emerald-400">Erica Cardenas</h2>
            </div>
            
            <p class="text-slate-400 mb-8 text-lg">Ready to start your rehabilitation training?</p>
            
            <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700 mb-8">
                <p class="text-slate-300 text-sm">I'll be waiting for your progress via WhatsApp. Give it your best effort.</p>
            </div>

            <button onclick="goToStart()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-bold text-xl transition-all shadow-lg shadow-emerald-900/20">
                START TRAINING
            </button>
        </div>

        <!-- Start Screen -->
        <div id="screen-start" class="hidden text-center">
            <h1 class="text-3xl font-bold mb-4 text-blue-400">Integral Training</h1>
            <p class="mb-6 text-slate-400">2 Rounds ‚Ä¢ 4 Exercises ‚Ä¢ Stretching ‚Ä¢ Final Cardio</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 text-left text-sm">
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <p class="font-bold text-blue-300 mb-2 uppercase tracking-tight text-xs">Required Equipment:</p>
                    <ul class="space-y-1 text-slate-300">
                        <li class="flex items-center gap-2"><span>üí™</span> Dumbbells</li>
                        <li class="flex items-center gap-2"><span>ü™ë</span> Bench</li>
                        <li class="flex items-center gap-2"><span>üíß</span> Water</li>
                        <li class="flex items-center gap-2"><span>üîî</span> Kettlebell</li>
                        <li class="flex items-center gap-2"><span>üèÉ</span> Treadmill</li>
                    </ul>
                </div>
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <p class="font-bold text-blue-300 mb-2 uppercase tracking-tight text-xs">Structure:</p>
                    <ul class="space-y-1 text-slate-300">
                        <li>‚è±Ô∏è 30s Preparation</li>
                        <li>üî• 20s Exercise</li>
                        <li>üìù Post-effort feedback</li>
                        <li>üö¥ 15 min Cardio (Z3-Z4)</li>
                    </ul>
                </div>
            </div>

            <button onclick="startTraining()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl font-bold text-xl transition-all shadow-lg shadow-blue-900/20 mb-4">
                START TRAINING
            </button>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="quickStretching()" class="py-3 bg-orange-600 hover:bg-orange-500 rounded-2xl font-semibold transition-all">
                    üßò Quick Stretching
                </button>
                <button onclick="quickCardio()" class="py-3 bg-red-600 hover:bg-red-500 rounded-2xl font-semibold transition-all">
                    üèÉ Quick Cardio
                </button>
            </div>
        </div>

        <!-- Timer / Exercise Screen -->
        <div id="screen-timer" class="hidden text-center">
            <div class="flex justify-between items-center mb-6">
                <span id="round-indicator" class="px-3 py-1 bg-blue-900/50 text-blue-300 rounded-full text-xs font-bold uppercase tracking-widest">Round 1</span>
                <span id="exercise-name" class="text-xl font-semibold">Exercise 1</span>
            </div>

            <!-- Video Placeholder -->
            <div id="video-container" class="aspect-video bg-black rounded-2xl mb-6 overflow-hidden flex items-center justify-center border border-slate-700">
                <p class="text-slate-500 text-sm p-4 text-center italic">Loading player...</p>
            </div>

            <div class="relative flex items-center justify-center mb-6">
                <svg class="w-40 h-40 transform -rotate-90">
                    <circle cx="80" cy="80" r="70" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-800" />
                    <circle id="timer-progress" cx="80" cy="80" r="70" stroke="currentColor" stroke-width="8" fill="transparent" stroke-dasharray="440" stroke-dashoffset="0" class="text-blue-500 timer-circle" />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="timer-label" class="text-xs uppercase text-slate-400 tracking-widest mb-1">Preparation</span>
                    <span id="timer-seconds" class="text-5xl font-bold">30</span>
                </div>
            </div>

            <p id="next-instruction" class="text-slate-400 italic text-sm">Get ready to begin...</p>

            <div class="grid grid-cols-2 gap-3 mt-8">
                <button onclick="quickStretching()" class="py-2 bg-orange-600 hover:bg-orange-500 rounded-xl font-semibold text-sm transition-all">
                    üßò Stretching
                </button>
                <button onclick="quickCardio()" class="py-2 bg-red-600 hover:bg-red-500 rounded-xl font-semibold text-sm transition-all">
                    üèÉ Cardio
                </button>
            </div>
        </div>

        <!-- Feedback Screen (Questions) -->
        <div id="screen-feedback" class="hidden">
            <h2 class="text-2xl font-bold mb-6 text-center">Effort Registration</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Heart Rate (BPM)</label>
                    <input type="number" id="input-hr" placeholder="e.g.: 145" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Difficulty Level (1-10)</label>
                    <input type="range" id="input-difficulty" min="1" max="10" class="w-full accent-blue-500">
                    <div class="flex justify-between text-xs text-slate-500 px-1 mt-1">
                        <span>Easy</span><span>Medium</span><span>Extreme</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-2">Notes / Sensations</label>
                    <textarea id="input-notes" rows="2" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="How did you feel?"></textarea>
                </div>
                <button onclick="saveFeedback()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-bold transition-all">
                    NEXT STEP
                </button>
            </div>
        </div>

        <!-- Stretching Screen -->
        <div id="screen-stretching" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4">Stretching Phase</h2>
            <p class="text-slate-400 mb-6 text-sm">Take your time to recover.</p>
            <div class="aspect-video bg-black rounded-2xl mb-8 overflow-hidden">
                <iframe id="stretch-video" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
            </div>
            <button onclick="goToCardio()" class="w-full py-4 bg-orange-600 hover:bg-orange-500 rounded-2xl font-bold transition-all">
                GO TO FINAL CARDIO (15 MIN)
            </button>
        </div>

        <!-- Cardio Screen (Treadmill) -->
        <div id="screen-cardio" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-6">Cardio Session - Heart Rate Targets</h2>

            <div class="bg-slate-800/50 p-6 rounded-3xl mb-6 border border-slate-700">
                <div class="text-7xl font-mono font-bold text-blue-400 mb-2" id="cardio-timer">15:00</div>
                <p id="cardio-instruction" class="text-lg font-semibold text-white mt-4">Warm-up Zone</p>
                <p id="cardio-bpm-target" class="text-3xl font-bold text-emerald-400 mt-2">60-80 BPM</p>
                <p class="text-sm text-slate-400 mt-2 italic" id="cardio-description">Adjust speed or incline to reach target heart rate</p>
            </div>

            <div id="cardio-progress-container" class="w-full h-3 bg-slate-700 rounded-full mb-6 overflow-hidden">
                <div id="cardio-progress-bar" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div>
            </div>

            <div class="grid grid-cols-1 gap-4 text-left mb-6">
                <div class="p-4 bg-slate-800 rounded-xl border border-slate-700">
                    <p class="text-[10px] text-slate-500 uppercase font-bold mb-2">‚è±Ô∏è Time Breakdown</p>
                    <ul class="text-xs text-slate-300 space-y-1">
                        <li>Min 15:00 a 12:00: 60-80 BPM (Warm-up)</li>
                        <li>Min 12:00 a 10:00: 150-155 BPM (High intensity)</li>
                        <li>Min 10:00 a 07:00: 140-150 BPM (Moderate intensity)</li>
                        <li>Min 07:00 a 03:00: 150-155 BPM (High intensity)</li>
                        <li>Min 03:00 a 00:00: &lt;100 BPM (Cool down)</li>
                    </ul>
                </div>
            </div>

            <button onclick="finishCardio()" class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-semibold transition-all">
                ‚úì Finish Cardio
            </button>
        </div>

        <!-- Completion and WhatsApp Sending Screen -->
        <div id="screen-finish" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4 text-emerald-400">‚úÖ TRAINING COMPLETED!</h2>
            <p class="text-slate-400 mb-6">Press the button to send the report via WhatsApp</p>
            
            <div id="summary-data" class="bg-slate-800/50 p-4 rounded-xl border border-slate-700 mb-6 text-left text-sm space-y-2">
                <p><span class="text-slate-500">Date:</span> <span id="summary-date" class="font-semibold"></span></p>
                <p><span class="text-slate-500">Exercises completed:</span> <span id="summary-exercises" class="font-semibold text-blue-400">8</span></p>
                <p><span class="text-slate-500">Average score:</span> <span id="summary-avg-difficulty" class="font-semibold text-orange-400">7.5/10</span></p>
                <p><span class="text-slate-500">Average HR:</span> <span id="summary-avg-hr" class="font-semibold text-red-400">145 BPM</span></p>
            </div>

            <button onclick="sendViaWhatsApp()" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 rounded-2xl font-bold text-xl transition-all shadow-lg shadow-emerald-900/20 mb-3 flex items-center justify-center gap-2">
                üì± SEND VIA WHATSAPP
            </button>
            
            <button onclick="downloadReport()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-2xl font-semibold transition-all">
                üìÑ DOWNLOAD REPORT
            </button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN DE EJERCICIOS (REEMPLAZA LOS IDs DE YOUTUBE)
        const ejercicios = [
            { id: 1, nombre: "Squats / Goblet Squat", videoUrl: "1.mp4" },
            { id: 2, nombre: "Incline Push-up", videoUrl: "2.mp4" },
            { id: 3, nombre: "Romanian Deadlift", videoUrl: "3.mp4" },
            { id: 4, nombre: "Thruster", videoUrl: "4.mp4" }
        ];

        const videoElongacionId = "IjH_8pdybfs"; 

        let currentRound = 1;
        let currentExerciseIdx = 0;
        let timerInterval;
        let cardioInterval;
        let cardioTimeLeft = 15 * 60;
        let sessionData = [];
        let phoneNumber = ""; // Will be requested from user
        let wakeLock = null; // Screen Wake Lock

        // Request screen to stay on during training
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen wake lock activated');
                }
            } catch (err) {
                console.log('Wake lock error: ' + err.message);
            }
        }

        // Release screen lock
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                    console.log('Screen wake lock released');
                }).catch(err => console.log('Error releasing wake lock: ' + err.message));
            }
        }

        // Re-acquire wake lock if document becomes visible
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        // Funci√≥n para generar un sonido de alerta
        function playBeep() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                oscillator.connect(gain);
                gain.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000; // Frecuencia en Hz
                oscillator.type = 'sine';
                
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not available');
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(`screen-${screenId}`).classList.remove('hidden');
        }

        function startTraining() {
            currentRound = 1;
            currentExerciseIdx = 0;
            requestWakeLock(); // Keep screen on
            runExerciseCycle();
        }

        function goToStart() {
            showScreen('start');
        }

        function runExerciseCycle() {
            showScreen('timer');
            const exercise = ejercicios[currentExerciseIdx];
            document.getElementById('exercise-name').innerText = exercise.nombre;
            document.getElementById('round-indicator').innerText = `Round ${currentRound}`;
            
            // Detectar si es un archivo local o YouTube
            if (exercise.videoUrl.includes('.mp4') || exercise.videoUrl.includes('.webm')) {
                // Video local
                document.getElementById('video-container').innerHTML = `<video class="w-full h-full" autoplay muted loop playsinline><source src="${exercise.videoUrl}" type="video/mp4">Tu navegador no soporta video</video>`;
            } else {
                // YouTube
                document.getElementById('video-container').innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${exercise.videoUrl}?autoplay=1&mute=1" frameborder="0" allowfullscreen></iframe>`;
            }
            
            startTimer(30, "Preparation", () => {
                startTimer(20, "¬°EJERCICIO!", () => {
                    showScreen('feedback');
                });
            });
        }

        function startTimer(seconds, label, onComplete) {
            let timeLeft = seconds;
            const labelEl = document.getElementById('timer-label');
            const secondsEl = document.getElementById('timer-seconds');
            const progressEl = document.getElementById('timer-progress');
            const circumference = 440;

            labelEl.innerText = label;
            labelEl.className = label === "¬°EJERCICIO!" ? "text-xs uppercase text-orange-400 animate-pulse font-bold" : "text-xs uppercase text-slate-400 tracking-widest";
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                secondsEl.innerText = timeLeft;
                const offset = circumference - (timeLeft / seconds) * circumference;
                progressEl.style.strokeDashoffset = offset;

                // Reproducir sonido en los √∫ltimos 5 segundos (5,4,3,2,1)
                if (timeLeft >= 1 && timeLeft <= 5) {
                    playBeep();
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    onComplete();
                }
                timeLeft--;
            }, 1000);
        }

        function saveFeedback() {
            const data = {
                ronda: currentRound,
                ejercicio: ejercicios[currentExerciseIdx].nombre,
                hr: document.getElementById('input-hr').value,
                difficulty: document.getElementById('input-difficulty').value,
                notes: document.getElementById('input-notes').value
            };
            
            // Guardar en array de sesi√≥n
            sessionData.push(data);
            console.log("Dato guardado:", data);

            // Limpiar inputs
            document.getElementById('input-hr').value = '';
            document.getElementById('input-notes').value = '';

            currentExerciseIdx++;
            if (currentExerciseIdx >= ejercicios.length) {
                if (currentRound < 2) {
                    currentRound++;
                    currentExerciseIdx = 0;
                    runExerciseCycle();
                } else {
                    showStretching();
                }
            } else {
                runExerciseCycle();
            }
        }

        function showFinishScreen() {
            showScreen('finish');
            releaseWakeLock(); // Release screen lock when done
            
            // Calcular estad√≠sticas
            const avgDifficulty = (sessionData.reduce((a, b) => a + parseInt(b.difficulty), 0) / sessionData.length).toFixed(1);
            const avgHR = Math.round(sessionData.reduce((a, b) => a + parseInt(b.hr || 0), 0) / sessionData.filter(d => d.hr).length);
            
            document.getElementById('summary-date').innerText = new Date().toLocaleDateString('es-AR');
            document.getElementById('summary-exercises').innerText = sessionData.length;
            document.getElementById('summary-avg-difficulty').innerText = `${avgDifficulty}/10`;
            document.getElementById('summary-avg-hr').innerText = `${avgHR} BPM`;
        }

        function sendViaWhatsApp() {
            phoneNumber = "17133844263"; // Therapist's number

            // Create message with training data
            let mensaje = `üìã *TRAINING REPORT*\n\n`;
            mensaje += `üìÖ Date: ${new Date().toLocaleDateString('en-US')}\n`;
            mensaje += `‚è∞ Time: ${new Date().toLocaleTimeString('en-US')}\n\n`;
            mensaje += `*SUMMARY:*\n`;
            mensaje += `‚úÖ Exercises completed: ${sessionData.length}\n`;
            mensaje += `üí™ Average difficulty: ${(sessionData.reduce((a, b) => a + parseInt(b.difficulty), 0) / sessionData.length).toFixed(1)}/10\n`;
            mensaje += `‚ù§Ô∏è Average HR: ${Math.round(sessionData.reduce((a, b) => a + parseInt(b.hr || 0), 0) / sessionData.filter(d => d.hr).length)} BPM\n\n`;
            
            mensaje += `*EXERCISE DETAILS:*\n`;
            sessionData.forEach((item, idx) => {
                mensaje += `${idx + 1}. ${item.ejercicio} (Round ${item.ronda})\n`;
                mensaje += `   ‚Ä¢ HR: ${item.hr || 'Not recorded'} BPM\n`;
                mensaje += `   ‚Ä¢ Difficulty: ${item.difficulty}/10\n`;
                if (item.notes) mensaje += `   ‚Ä¢ Note: ${item.notes}\n`;
            });
            
            mensaje += `\nüì± Sent from ClinicFit`;

            // Create WhatsApp link
            const urlWhatsApp = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(mensaje)}`;
            window.open(urlWhatsApp, '_blank');
        }

        function downloadReport() {
            let csv = "Round,Exercise,HR,Difficulty,Notes\n";
            sessionData.forEach(item => {
                csv += `${item.ronda},"${item.ejercicio}",${item.hr},${item.difficulty},"${item.notes}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Training_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function showStretching() {
            showScreen('stretching');
            document.getElementById('stretch-video').src = `https://www.youtube.com/embed/${videoElongacionId}?autoplay=1`;
        }

        function goToCardio() {
            showScreen('cardio');
            startCardioTimer();
        }

        function quickStretching() {
            cardioTimeLeft = 15 * 60; // Reset cardio timer
            showStretching();
        }

        function quickCardio() {
            cardioTimeLeft = 15 * 60; // Reset cardio timer
            goToCardio();
        }

        function finishCardio() {
            clearInterval(cardioInterval);
            releaseWakeLock();
            showFinishScreen();
        }

        function startCardioTimer() {
            const timerEl = document.getElementById('cardio-timer');
            const instructionEl = document.getElementById('cardio-instruction');
            const bpmTargetEl = document.getElementById('cardio-bpm-target');
            const descriptionEl = document.getElementById('cardio-description');
            const progressEl = document.getElementById('cardio-progress-bar');
            
            const totalDuration = 15 * 60;

            clearInterval(cardioInterval);
            cardioInterval = setInterval(() => {
                const minutes = Math.floor(cardioTimeLeft / 60);
                const seconds = cardioTimeLeft % 60;
                timerEl.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = ((totalDuration - cardioTimeLeft) / totalDuration) * 100;
                progressEl.style.width = `${progress}%`;

                // Based on remaining time (cardioTimeLeft)
                if (cardioTimeLeft > 12 * 60) {
                    // 15:00 to 12:00 - Warm-up
                    instructionEl.innerText = "üîµ WARM-UP ZONE";
                    bpmTargetEl.innerText = "60-80 BPM";
                    bpmTargetEl.className = "text-3xl font-bold text-blue-400 mt-2";
                    descriptionEl.innerText = "Start easy and gradually increase pace";
                } else if (cardioTimeLeft > 8 * 60) {
                    // 12:00 to 8:00 - High intensity
                    instructionEl.innerText = "üî¥ HIGH INTENSITY";
                    bpmTargetEl.innerText = "150-155 BPM";
                    bpmTargetEl.className = "text-3xl font-bold text-red-400 mt-2";
                    descriptionEl.innerText = "Push hard - maintain high heart rate";
                } else if (cardioTimeLeft > 5 * 60) {
                    // 8:00 to 5:00 - Moderate intensity
                    instructionEl.innerText = "üü† MODERATE INTENSITY";
                    bpmTargetEl.innerText = "140-150 BPM";
                    bpmTargetEl.className = "text-3xl font-bold text-orange-400 mt-2";
                    descriptionEl.innerText = "Maintain moderate but steady effort";
                } else if (cardioTimeLeft > 3 * 60) {
                    // 5:00 to 3:00 - High intensity
                    instructionEl.innerText = "üî¥ HIGH INTENSITY";
                    bpmTargetEl.innerText = "150-155 BPM";
                    bpmTargetEl.className = "text-3xl font-bold text-red-400 mt-2";
                    descriptionEl.innerText = "Push hard again - final sprint zone";
                } else if (cardioTimeLeft > 0) {
                    // 3:00 to 0:00 - Cool down
                    instructionEl.innerText = "üü¢ COOL DOWN";
                    bpmTargetEl.innerText = "< 100 BPM";
                    bpmTargetEl.className = "text-3xl font-bold text-emerald-400 mt-2";
                    descriptionEl.innerText = "Bring heart rate down gradually";
                }

                if (cardioTimeLeft <= 0) {
                    clearInterval(cardioInterval);
                    timerEl.innerText = "DONE";
                    instructionEl.innerText = "Excellent work!";
                    bpmTargetEl.innerText = "‚úÖ COMPLETED";
                    bpmTargetEl.className = "text-3xl font-bold text-emerald-400 mt-2";
                    
                    // Show finish screen after 2 seconds
                    setTimeout(() => {
                        showFinishScreen();
                    }, 2000);
                }
                cardioTimeLeft--;
            }, 1000);
        }
    </script>
</body>
</html>
